<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="all.css" rel="stylesheet" />
    <script>
        var require = function () { }
    </script>
    <script src="jquery.min.js"></script>
    <script src="vue.min.js"></script>
    <script src="lodash.min.js"></script>
    <script src="masa.js"></script>
    <meta charset="utf-8" />


    <style>

    </style>
</head>

<body>
    <div id="content">
        <h4>{{title}}</h4>
        <div class="filter-box" style="display:block">
            <div class="filter">
                <!-- B filter groups -->
                <div class="filter-groups">
                    <!-- B row -->
                    <div class="filter-row">
                        <div class="filter-head">汇总方式</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="radio" name="radio1">汇总方式</label></span>
                        </div>
                    </div>
                    <!-- E row -->
                    <!-- B row -->
                    <div class="filter-row">
                        <div class="filter-head">时间范围</div>
                        <div class="filter-body">
                            <div class="calendar-box">
                                <div class="calendar"><input type="text" placeholder="请选择开始时间"></div>
                                <span class="help-margin">至</span>
                                <div class="calendar"><input type="text" placeholder="请选择结束时间"></div>
                            </div>
                        </div>
                    </div>
                    <!-- E row -->
                    <!-- B row -->
                    <div class="filter-row">
                        <div class="filter-head">房屋属性</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="radio" name="radio1">新房</label></span>
                            <span class="check-box"><label><input type="radio" name="radio1">二手房</label></span>
                        </div>
                    </div>
                    <!-- E row -->
                    <!-- B row -->
                    <masa-districtplat></masa-districtplat>
                    <!-- E filter-children -->
                    <!-- B finder row -->
                    <!-- E finder row -->
                </div>
                <!-- E filter groups -->
                <!-- B more -->
                <div class="filter-more-switch">－隐藏更多条件</div>
                <!-- E more -->
                <!-- B row groups -->
                <div class="filter-groups" style="display:none;">
                    <div class="filter-row">
                        <div class="filter-head">行政区</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="checkbox">全部</label></span>
                            <span class="check-box"><label><input type="checkbox">内环内</label></span>
                            <span class="check-box"><label><input type="checkbox">内中环间</label></span>
                            <span class="check-box"><label><input type="checkbox">外郊环间</label></span>
                            <span class="check-box"><label><input type="checkbox">郊环以外</label></span>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-head">环线</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="checkbox">全部</label></span>
                            <span class="check-box"><label><input type="checkbox">内环内</label></span>
                            <span class="check-box"><label><input type="checkbox">内中环间</label></span>
                            <span class="check-box"><label><input type="checkbox">外郊环间</label></span>
                            <span class="check-box"><label><input type="checkbox">郊环以外</label></span>
                        </div>
                    </div>
                    <div class="filter-row bg">
                        <div class="filter-head">板块</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="checkbox">全部</label></span>
                            <span class="check-box"><label><input type="checkbox">内环内</label></span>
                            <span class="check-box"><label><input type="checkbox">内中环间</label></span>
                            <span class="check-box"><label><input type="checkbox">外郊环间</label></span>
                            <span class="check-box"><label><input type="checkbox">郊环以外</label></span>
                        </div>
                    </div>
                    <div class="filter-row bg">
                        <div class="filter-head">物业</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="checkbox">全部</label></span>
                            <span class="check-box"><label><input type="checkbox">内环内</label></span>
                            <span class="check-box"><label><input type="checkbox">内中环间</label></span>
                            <span class="check-box"><label><input type="checkbox">外郊环间</label></span>
                            <span class="check-box"><label><input type="checkbox">郊环以外</label></span>
                        </div>
                    </div>
                    <div class="filter-row bg">
                        <div class="filter-head">房型</div>
                        <div class="filter-body">
                            <span class="check-box"><label><input type="checkbox">全部</label></span>
                            <span class="check-box"><label><input type="checkbox">内环内</label></span>
                            <span class="check-box"><label><input type="checkbox">内中环间</label></span>
                            <span class="check-box"><label><input type="checkbox">外郊环间</label></span>
                            <span class="check-box"><label><input type="checkbox">郊环以外</label></span>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-head">面积</div>
                        <div class="filter-body">
                            <input type="text" class="form-input"><span class="help-margin">至</span><input type="text" class="form-input"><span class="help-margin">平方米</span>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-head">面积</div>
                        <div class="filter-body">
                            <div class="select">
                                <select name="" id="">
                                    <option value="">请选择</option>
                                    <option value="">请选择</option>
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- E row groups -->
            </div>
            <div class="filter-bottom-btn">
                <button type="button" class="btn btn-primary js-filter-btn">确 认</button>
                <button type="button" class="btn btn-warning js-cancel-btn">取 消</button>
            </div>
            <div class="btn-close-filter"><i class="iconfont icon-angle-double-up"></i></div>
        </div>





    </div>


    <script type="text/template" id="component">
        <div class="masa-components">

            <div v-if="items.length>0">
                <span class="check-box" v-for="(item,index) in items"><label><input type="radio" v-bind:name="radioname" v-on:click="onSelect(index,$event)" v-model.lazy="values"  v-bind:value="item.value" ><b>{{item.text}}</b></label></span>
            </div>
            <div v-else="isLoadComplete" v-html="loadtext"></div>
        </div>
    </script>
    <script type="text/template" id="component2">
        <div class="masa-components">

            <div class="filter-row">
                <div class="filter-head">行政区域</div>
                <div class="filter-body hidden-check-box ">
                    <masa-checkboxlist ref="districtCheckbox" v-bind:source="districtSource"  v-bind:selected-value="districtValuesL" v-bind:default-labels="[{id:'',name:'全部'}]" value-field="id" text-field="name"></masa-checkboxlist>
                </div>
            </div>
            <!-- E row -->
            <!-- B filter-children -->
            <div class="filter-children" v-show="showPlat">
                <p>
                    <masa-checkboxlist ref="platCheckbox" v-bind:auto-bind="false" v-bind:source="platSource" v-bind:selected-value="platValuesL"  value-field="id" text-field="name"></masa-checkboxlist>
                </p>

            </div>
            <div class="filter-row finder">
                <div class="filter-head">当前选择</div>
                <div class="filter-body hidden-check-box button-checkbox">
                    <!-- 隐藏checkbox -->
                    <template v-for="item in selectLabels">
                        <span class="check-box remove-onelabel-dx" v-bind:data-value="item.value" v-bind:data-level="item.level"><label >{{item.text}}</label></span>
                    </template>

                    <a href="javascript:void(0)" class="clear-all">清除全部</a>
                </div>
            </div>
        </div>
    </script>
    <style>

        /*.filter-row .filter-body.hidden-check-box .check-box input:checked + b {
            color: #fff;
            text-decoration: none;
        }
                .filter-row .filter-body.hidden-check-box .check-box input.checked + b {
            color: #3aa6fa;
            text-decoration: underline;
        }

        .filter-children p .check-box input:checked + b {
            color: #fff;
            text-decoration: none;
        }*/
    </style>
    <script>


            var component = {
                template: $('#component').html(),
                data: function () {
                    return {
                        loadtext: "正在加载中...",
                        radioname: _.uniqueId('radio_dx_component'),
                        values: this.selectedValue,
                        items: []
                    };
                },
                computed: {

                },
                watch: {},
                methods: {
                    read: function (data) {
                        var that = this;
                        that.items = [];
                        that.values = that.selectedValue;
                        that.loadtext = "正在加载中....";
                        that.source.read(data);
                    },
                    onSelect:function(index,e)
                    {
                        var item = this.items[index];
                        this.$emit('change', item);
                    },
                    getCheckedData:function()
                    {
                        var value = this.values;
                        var item = Masa._.find(this.items, function (d) { return d.value == value; });
                        return item;
                    }
                },
                props: {
                    source: Masa.DataSource,
                    autoBind: {
                        type: Boolean,
                        default: true
                    },
                    defaultLabels: {
                        type: Array,
                        default: function () {
                            return [];
                        }
                    },
                    valueField: {
                        type: String,
                        default: "value"
                    },
                    selectedValue: {
                        type: String,
                        default:''
                    },
                    textField: {
                        type: String,
                        default: "text"
                    }
                },
                beforeCreate: function () { },
                created: function () { },
                mounted: function () {
                    var that = this, selectedAll = that.selectedAll;
                    that.source.then(function (data) {
                        if (data.length <= 0) {
                            that.laodtext = '';
                            return;
                        }
                        var items = [];
                        Masa._.each(that.defaultLabels, function (d) {
                        
                            var item = {};
                            item.value = d[that.valueField];
                            item.text = d[that.textField];
                            item.orgData =data.length>0?data[0]:null;
                            items.push(item);
                        });
                        Masa._.each(data, function (d) {
                            var item = {};
                            item.value = d[that.valueField];
                            item.text = d[that.textField];
                            item.orgData = d;
                            items.push(item);
                        });
                        that.items = items;
                        that.$emit('refresh');
                    }, function () {
                        that.loadtext = '加载数据失败,请刷新!<a href="javascript:void(0)" class="refreshLoad" style="color:#0dd78a">点击刷新</a>';
                        that.$emit('fail');
                    });
                    if (that.autoBind) {
                        that.read();
                    }
                    $(that.$el).on('click', 'a.refreshLoad', function () {
                        that.loadtext = '正在加载中...';
                        setTimeout(function () {
                            that.source.read();
                        }, 1000);
                    });
                },
                destroyed: function () {
                    $(this.$el).off();
                }
            };
            Masa.Vue.component('masa-checkboxlist', component);

            ///            'district': 'sys/dict/district?cityId=1', //行政区
           // 'plate': 'sys/dict/plate', //板块
            var component2 = {
                template: $('#component2').html(),
                data: function data() {
                    return {
                        districtSource: Masa.DataSource({
                            transport: {
                                name: "*",
                                url: "http://172.18.84.65:8808/masa/a/sys/dict/district?cityId=1"
                            }
                        }),
                        platSource: Masa.DataSource({
                            transport: {
                                name: "*",
                                url: "http://172.18.84.65:8808/masa/a/sys/dict/plate",
                                data: {
                                    districtId: ''
                                }
                            }
                        }),
                        districtValues: [],
                        platValues: [],
                        districtValuesL: '',
                        platValuesL: '',
                        selectLabels: [],
                        showPlat: false,
                        showSelectPanel:false
                    };
                },
                computed: {},
                watch: {
                    selectLabels:function()
                    {
                        this.districtValues = Masa._.map(Masa._.filter(this.showSelectPanel, function (d) { return d.level == 1; }), function (d) { return d.value; });
                        this.platValues = Masa._.map(Masa._.filter(this.showSelectPanel, function (d) { return d.level == 2; }), function (d) { return d.value; });
                    }
                },
                methods: {
                    refreshLabels:function()
                    {
                       var that = this;
                       var newLabels = [];
                    
                       that.selectLabels = newLabels;
          
                    },
                    addArea:function(item)
                    {
                        var that = this;
                        var labels = that.selectLabels, newLabels=[];
                        var isExist = that.isExistArea(item.value), isExistAll = that.isExistArea(''), isPlat = that.isExistPlatByAreaId(item.value);
                       
                        if (item.value != '') {
                            that.removeArea('');
                        } else {
                            that.removeAll();
                        }
                        if (!isExist && !isPlat)
                        {
                           
                            labels.push({
                                level: 1,
                                value: item.value,
                                text: item.text
                            });
                        }
                             
                    },
                    isExistArea:function(id)
                    {
                        return Masa._.some(this.selectLabels, function (d) { return d.level==1 && d.value == id; });
                    },
                    isExistPlat: function (id) {
                        return Masa._.some(this.selectLabels, function (d) { return d.level == 2 && d.value == id; });
                    },
                    remove:function(list,fn)
                    {
                        var i=list.length-1;
                        for (; i >= 0;i--)
                        {
                            if (fn(list[i]) === true) {
                                list.splice(i, 1);
                            }
                        }
                    },
                    removeAll: function () {
                        this.selectLabels.splice(0);
                    },
                    removeArea:function(id)
                    {
                      this.remove(this.selectLabels, function (d) { return d.level == 1 && d.value == id; });                  
                    },
                    removePlatId: function (id) {
                        this.remove(this.selectLabels, function (d) { return d.level == 2 && d.value == id; });
                     
                    },
                    removePlatByAreaId: function (id) {
                        this.remove(this.selectLabels, function (d) { return d.level == 2 && d.districtId == id; });
                    },
                    isExistPlatByAreaId: function (id) {
                       return Masa._.some(this.selectLabels, function (d) { return d.level == 2 && d.districtId == id; });
                    },
                    addPlat: function (item) {
                        var that = this, orgData = item.orgData;
                        var labels = that.selectLabels, newLabels = [];
                        var isExist = that.isExistPlat(item.value);                      
                        if (!isExist) {                
                            that.removeArea(orgData.districtId);                                         
                            labels.push({
                                districtId: orgData.districtId,
                                level: 2,
                                value: item.value,
                                text: item.text + '(' + orgData.districtName + ')'
                            });
                        }
                    },
                    showPlatPanel: function (data)
                    {
                        var that = this;
                        if (data.value != '') {
                            that.$refs.platCheckbox.values = null;
                            that.platSource.read({
                                districtId: data.value
                            });
                        } else {
                            that.showPlat = false;
                        }
                    }
                },
                props: {},
                beforeCreate: function beforeCreate() { },
                created: function created() {
                },
                mounted: function mounted() {
                    var that = this;
               //     that.bindCheckboxEvent("districtCheckbox", "districtValues");
                   // that.bindCheckboxEvent("platCheckbox", "platValues");
                    that.$refs.platCheckbox.$on('fail', function () {
                        that.showPlat = false;
                    });
                    that.$refs.platCheckbox.$on('refresh', function () {
                        that.showPlat = true;
                    });
                    that.$refs.districtCheckbox.$on('refresh', function () {
          
                        var item = that.$refs.districtCheckbox.getCheckedData();
                        if (item) {
                            that.addArea(item);
                        }
                    });
     
                    that.$refs.districtCheckbox.$on('change', function (data) {
                        that.showPlatPanel(data);
                        that.addArea(data);
                    });
                    that.$refs.platCheckbox.$on('change', function (data) {                        
                        that.addPlat(data);
                    });
                  
                    $(that.$el).on('click', '.clear-all', function () {
                        that.showPlat = false;
                        that.removeAll();      
                        that.$refs.districtCheckbox.values = '';
                        var item = that.$refs.districtCheckbox.getCheckedData();
                        if (item) {
                            that.addArea(item);
                        }

                    });
                    $(that.$el).on('click', '.remove-onelabel-dx', function (e) {
                        var value = e.currentTarget.getAttribute('data-value'), level = e.currentTarget.getAttribute('data-level');;
                        if(level==2)
                        {
                            that.removePlatId(value);
                        } else if (level ==1) {
                            that.removeArea(value);
                        }

                    });

                },
                destroyed: function destroyed() { }
            };
            Masa.Vue.component('masa-districtplat', component2);
            var view = new Vue({
                data:{title:"实例"},
                el: "#content"
            });




    </script>
</body>
</html>
